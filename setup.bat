@echo off
title PhysioAI - Setup Completo
color 0A

echo.
echo ===============================================
echo           üöÄ PHYSIO AI SETUP üöÄ
echo ===============================================
echo.
echo Questo script installer√† e avvier√† PhysioAI
echo automaticamente su questo computer.
echo.
pause

REM Salva directory corrente
set "ROOT_DIR=%CD%"
echo üìÇ Directory root: %ROOT_DIR%
echo.

echo üîç CONTROLLI INIZIALI...
echo.

REM ==================== CONTROLLO PYTHON ====================
echo üìã Controllo Python...
python --version >nul 2>&1
if %errorlevel% neq 0 (
    py --version >nul 2>&1
    if %errorlevel% neq 0 (
        python3 --version >nul 2>&1
        if %errorlevel% neq 0 (
            echo ‚ùå PYTHON NON TROVATO!
            echo.
            echo Per installare Python:
            echo 1. Vai su: https://python.org/downloads
            echo 2. Scarica Python 3.11 (NON 3.12+)
            echo 3. IMPORTANTE: Spunta "Add Python to PATH"
            echo 4. Installa e riavvia questo script
            echo.
            start https://www.python.org/downloads/release/python-3119/
            pause
            exit /b 1
        ) else (
            set PYTHON_CMD=python3
        )
    ) else (
        set PYTHON_CMD=py
    )
) else (
    set PYTHON_CMD=python
)

echo ‚úÖ Python trovato: %PYTHON_CMD%
%PYTHON_CMD% --version
echo.

REM ==================== CONTROLLO NODE.JS ====================
echo üìã Controllo Node.js...
node --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ùå NODE.JS NON TROVATO!
    echo.
    echo Per installare Node.js:
    echo 1. Vai su: https://nodejs.org
    echo 2. Scarica versione LTS (20.x)
    echo 3. Installa con impostazioni predefinite
    echo 4. Riavvia questo script
    echo.
    start https://nodejs.org/
    pause
    exit /b 1
)

echo ‚úÖ Node.js trovato!
node --version
npm --version
echo.

REM ==================== VERIFICA STRUTTURA ====================
echo üìã Verifica struttura progetto...

if not exist "backend" (
    echo ‚ùå Cartella 'backend' non trovata!
    echo Assicurati di essere nella directory root del progetto
    pause
    exit /b 1
)

if not exist "frontend" (
    echo ‚ùå Cartella 'frontend' non trovata!
    echo Assicurati di essere nella directory root del progetto
    pause
    exit /b 1
)

echo ‚úÖ Struttura progetto corretta
echo.

REM ==================== SETUP BACKEND ====================
echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë     üêç SETUP BACKEND PYTHON            ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

cd "%ROOT_DIR%\backend"

REM Verifica file main.py
if not exist "main.py" (
    echo ‚ö†Ô∏è  File main.py non trovato!
    echo Creazione file main.py in corso...
    echo # Placeholder > main.py
    echo ‚ùå ERRORE: Devi creare il file main.py manualmente
    echo Copia il codice del backend nell'artifact backend_main
    pause
    exit /b 1
)

REM Setup ambiente virtuale
if not exist "venv" (
    echo üì¶ Creazione ambiente virtuale Python...
    %PYTHON_CMD% -m venv venv
    if %errorlevel% neq 0 (
        echo ‚ùå Errore creazione ambiente virtuale!
        echo Verifica che Python sia installato correttamente
        pause
        exit /b 1
    )
    echo ‚úÖ Ambiente virtuale creato
) else (
    echo ‚úÖ Ambiente virtuale gi√† presente
)

echo.
echo üîÑ Attivazione ambiente virtuale...
call venv\Scripts\activate.bat
if %errorlevel% neq 0 (
    echo ‚ùå Errore attivazione venv!
    pause
    exit /b 1
)

echo ‚úÖ Ambiente attivato
echo.

echo ‚¨ÜÔ∏è  Aggiornamento pip...
python -m pip install --upgrade pip --quiet
python -m pip install wheel --quiet

echo.
echo üì¶ Installazione pacchetti Python...
echo    Questo pu√≤ richiedere alcuni minuti...
echo.

REM Installa requirements
if exist "requirements.txt" (
    echo üìÑ Installazione da requirements.txt...
    pip install -r requirements.txt
) else (
    echo üìã Installazione pacchetti individuali...
    
    echo    [1/15] FastAPI...
    pip install fastapi==0.104.1 --quiet
    
    echo    [2/15] Uvicorn...
    pip install uvicorn[standard]==0.24.0 --quiet
    
    echo    [3/15] Pydantic...
    pip install pydantic==2.5.0 --quiet
    
    echo    [4/15] Python Multipart...
    pip install python-multipart==0.0.6 --quiet
    
    echo    [5/15] OpenCV...
    pip install opencv-python==4.8.1.78 --quiet
    
    echo    [6/15] MediaPipe...
    pip install mediapipe==0.10.8 --quiet
    
    echo    [7/15] NumPy...
    pip install numpy==1.24.3 --quiet
    
    echo    [8/15] Firebase Admin...
    pip install firebase-admin==6.3.0 --quiet
    
    echo    [9/15] WebSockets...
    pip install websockets==12.0 --quiet
    
    echo    [10/15] Python Jose...
    pip install python-jose[cryptography]==3.3.0 --quiet
    
    echo    [11/15] Python Dotenv...
    pip install python-dotenv==1.0.0 --quiet
    
    echo    [12/15] Pillow...
    pip install Pillow==10.1.0 --quiet
    
    echo    [13/15] Aiofiles...
    pip install aiofiles==23.2.1 --quiet
    
    echo    [14/15] PyRealSense2 (opzionale - pu√≤ fallire se no SDK)...
    pip install pyrealsense2==2.54.2.5684 --quiet
    if %errorlevel% neq 0 (
        echo       ‚ö†Ô∏è  PyRealSense2 non installato - verr√† usata modalit√† MOCK
    )
    
    echo    [15/15] Email Validator...
    pip install email-validator==2.1.0 --quiet
)

if %errorlevel% neq 0 (
    echo.
    echo ‚ùå Errore durante installazione pacchetti!
    echo Controlla i messaggi di errore sopra
    pause
    exit /b 1
)

echo.
echo ‚úÖ Backend Python configurato correttamente!
echo.

REM Torna alla root
cd "%ROOT_DIR%"

REM ==================== SETUP FRONTEND ====================
echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë     ‚öõÔ∏è  SETUP FRONTEND REACT           ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

cd "%ROOT_DIR%\frontend"

REM Verifica package.json
if not exist "package.json" (
    echo ‚ùå File package.json non trovato!
    echo Crea prima il progetto React con: npm create vite@latest
    pause
    exit /b 1
)

if not exist "node_modules" (
    echo üì¶ Installazione dipendenze React...
    echo    Questo pu√≤ richiedere alcuni minuti...
    npm install
    if %errorlevel% neq 0 (
        echo.
        echo ‚ùå Errore npm install!
        echo Prova:
        echo 1. Cancella cartella node_modules se esiste
        echo 2. Cancella file package-lock.json se esiste
        echo 3. Riavvia questo script
        pause
        exit /b 1
    )
) else (
    echo ‚úÖ Dipendenze React gi√† installate
    echo    Verifico aggiornamenti...
    npm update --quiet
)

echo.
echo ‚úÖ Frontend React configurato correttamente!
echo.

REM Torna alla root
cd "%ROOT_DIR%"

REM ==================== VERIFICA FIREBASE ====================
echo.
echo üî• Controllo configurazione Firebase...

if not exist "backend\firebase-credentials.json" (
    echo.
    echo ‚ö†Ô∏è  FILE FIREBASE CREDENTIALS MANCANTE!
    echo.
    echo IMPORTANTE: Per usare Firebase devi:
    echo 1. Andare su https://console.firebase.google.com
    echo 2. Creare un progetto
    echo 3. Andare in Project Settings ^> Service Accounts
    echo 4. Cliccare "Generate New Private Key"
    echo 5. Salvare il file come: backend\firebase-credentials.json
    echo.
    echo üìù Il sistema funzioner√† comunque in modalit√† DEMO
    echo    ma non salver√† dati su Firebase
    echo.
    pause
) else (
    echo ‚úÖ Firebase credentials trovate!
)

echo.

REM ==================== AVVIO SISTEMA ====================
echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë     üöÄ AVVIO SISTEMA PHYSIOAI          ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

echo üì§ Avvio Backend (porta 8000)...
cd "%ROOT_DIR%\backend"

REM Avvia backend in nuova finestra
start "PhysioAI Backend" cmd /k "title PhysioAI Backend && color 0A && echo. && echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó && echo ‚ïë   üêç BACKEND SERVER PHYSIOAI           ‚ïë && echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù && echo. && echo üåê API: http://localhost:8000 && echo üìñ Docs: http://localhost:8000/docs && echo. && echo ‚ö†Ô∏è  NON CHIUDERE QUESTA FINESTRA! && echo üõë Premi Ctrl+C per fermare && echo. && call venv\Scripts\activate.bat && uvicorn main:app --host 0.0.0.0 --port 8000 --reload"

echo ‚è≥ Attesa avvio backend (8 secondi)...
timeout /t 8 /nobreak >nul

echo.
echo üì§ Avvio Frontend (porta 5173)...
cd "%ROOT_DIR%\frontend"

REM Avvia frontend in nuova finestra
start "PhysioAI Frontend" cmd /k "title PhysioAI Frontend && color 0B && echo. && echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó && echo ‚ïë   ‚öõÔ∏è  FRONTEND SERVER PHYSIOAI         ‚ïë && echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù && echo. && echo üåê App: http://localhost:5173 && echo. && echo ‚ö†Ô∏è  NON CHIUDERE QUESTA FINESTRA! && echo üõë Premi Ctrl+C per fermare && echo. && npm run dev"

echo ‚è≥ Attesa avvio frontend (6 secondi)...
timeout /t 6 /nobreak >nul

echo.
echo üåê Apertura browser...
timeout /t 2 /nobreak >nul
start http://localhost:5173

REM Torna alla root
cd "%ROOT_DIR%"

echo.
echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë                    üéâ PHYSIOAI ONLINE! üéâ                          ‚ïë
echo ‚ïë                                                                    ‚ïë
echo ‚ïë  üåê App:  http://localhost:5173                                    ‚ïë
echo ‚ïë  üîß API:  http://localhost:8000                                    ‚ïë
echo ‚ïë  üìñ Docs: http://localhost:8000/docs                              ‚ïë
echo ‚ïë                                                                    ‚ïë
echo ‚ïë  üìß Login: fisioterapista@test.com                                ‚ïë
echo ‚ïë  üîë Pass:  Test123!                                                ‚ïë
echo ‚ïë                                                                    ‚ïë
echo ‚ïë  ‚ö†Ô∏è  Camera RealSense non rilevata? Nessun problema!               ‚ïë
echo ‚ïë     Il sistema funziona in modalit√† MOCK con dati simulati        ‚ïë
echo ‚ïë                                                                    ‚ïë
echo ‚ïë  ‚ö†Ô∏è  NON CHIUDERE le finestre server!                               ‚ïë
echo ‚ïë     Per fermare: Ctrl+C nelle finestre server                     ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.
echo ‚úÖ Setup completato con successo!
echo.
echo üìã Note:
echo    - Backend gira su porta 8000
echo    - Frontend gira su porta 5173 (Vite default)
echo    - Camera mock attiva se RealSense non disponibile
echo.
echo üîÑ Per riavviare: esegui di nuovo questo file BAT
echo üõë Per fermare: Ctrl+C nelle finestre server
echo.
echo Il browser dovrebbe aprirsi automaticamente!
echo Se non si apre, vai su: http://localhost:5173
echo.
pause